<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>æ—©è¯»å£°æ§çƒ</title>
  <style>
    :root {
      --font-body: "YouYuan", "Yuanti SC", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "Heiti SC", sans-serif;
      --font-title: "YouYuan", "Yuanti SC", "PingFang SC", "Microsoft YaHei", "Heiti SC", sans-serif;
      --font-display: var(--font-title);
      --bg-1: #ffe7c7;
      --bg-2: #ffd08a;
      --bg-3: #9fe7d8;
      --panel-bg: rgba(255, 255, 255, 0.88);
      --panel-border: rgba(255, 255, 255, 0.7);
      --text-main: #1b2730;
      --text-muted: #51636b;
      --accent: #ff7a3d;
      --accent-2: #24b2a6;
      --accent-3: #ffbe55;
      --shadow: 0 16px 36px rgba(20, 45, 54, 0.16);
      --shadow-strong: 0 14px 28px rgba(255, 122, 61, 0.22);
      --radius-lg: 22px;
      --radius-sm: 14px;
    }

    * {
      box-sizing: border-box;
    }

    html, body {
      height: 100%;
    }

    body {
      margin: 0;
      position: relative;
      font-family: var(--font-body);
      color: var(--text-main);
      background: radial-gradient(circle at 12% 12%, rgba(255, 255, 255, 0.9) 0%, rgba(255, 247, 229, 0.95) 32%, transparent 60%),
        radial-gradient(circle at 88% 18%, rgba(217, 247, 240, 0.9) 0%, rgba(176, 232, 221, 0.4) 45%, transparent 68%),
        linear-gradient(135deg, var(--bg-1), var(--bg-2) 45%, var(--bg-3));
      overflow: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: radial-gradient(circle at 10% 18%, rgba(255, 255, 255, 0.7) 0 9px, transparent 10px),
        radial-gradient(circle at 82% 24%, rgba(255, 255, 255, 0.6) 0 11px, transparent 12px),
        radial-gradient(circle at 18% 78%, rgba(255, 255, 255, 0.5) 0 7px, transparent 8px),
        repeating-radial-gradient(circle at 50% 50%, rgba(255, 255, 255, 0.18) 0 2px, transparent 2px 12px);
      pointer-events: none;
      opacity: 0.55;
      z-index: 0;
    }

    body::after {
      content: "";
      position: fixed;
      inset: -12% -6% -8% -6%;
      background: radial-gradient(circle at 12% 20%, rgba(255, 201, 125, 0.35) 0 120px, transparent 150px),
        radial-gradient(circle at 88% 18%, rgba(156, 228, 216, 0.35) 0 140px, transparent 175px),
        radial-gradient(circle at 72% 82%, rgba(255, 151, 109, 0.25) 0 160px, transparent 190px);
      opacity: 0.75;
      pointer-events: none;
      z-index: 0;
      animation: floatBubbles 18s ease-in-out infinite alternate;
    }

    #app {
      position: relative;
      height: 100%;
      padding: 16px 20px 16px;
      display: grid;
      grid-template-rows: auto minmax(0, 1fr) auto;
      gap: 12px;
      z-index: 1;
    }

    header.app-header {
      display: flex;
      flex-wrap: nowrap;
      align-items: center;
      justify-content: space-between;
      gap: 14px;
      padding: 12px 18px;
      border-radius: var(--radius-lg);
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.96), rgba(255, 244, 231, 0.9));
      border: 2px solid rgba(255, 255, 255, 0.85);
      box-shadow: var(--shadow-strong);
      backdrop-filter: blur(8px);
      animation: floatIn 700ms ease;
    }

    .title-block {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 0;
      flex: 1 1 auto;
    }

    .title-icon {
      width: 34px;
      height: 34px;
      border-radius: 12px;
      position: relative;
      flex-shrink: 0;
      background: radial-gradient(circle at 30% 28%, rgba(255, 255, 255, 0.95) 0 6px, transparent 7px),
        radial-gradient(circle at 70% 70%, rgba(255, 255, 255, 0.4) 0 10px, transparent 12px),
        conic-gradient(from 20deg, #ff7a3d, #ffbe55, #7bd6ff, #6fe3c5, #ff7a3d);
      box-shadow: 0 10px 16px rgba(255, 122, 61, 0.3);
      animation: iconBounce 2.6s ease-in-out infinite;
    }

    .title-icon::after {
      content: "";
      position: absolute;
      inset: 6px;
      border-radius: 9px;
      border: 2px dashed rgba(255, 255, 255, 0.65);
      opacity: 0.7;
    }

    .title-text {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .title-block h1 {
      margin: 0;
      font-family: var(--font-title);
      font-size: clamp(22px, 2.6vw, 32px);
      letter-spacing: 1px;
      text-shadow: 0 2px 0 rgba(255, 255, 255, 0.8);
      animation: titlePop 700ms ease both;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .title-block p {
      margin: 4px 0 0;
      color: var(--text-muted);
      font-size: 12px;
      letter-spacing: 0.3px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .status-block {
      display: flex;
      align-items: center;
      gap: 12px;
      flex-wrap: nowrap;
      row-gap: 8px;
      justify-content: flex-end;
      white-space: nowrap;
      flex: 0 0 auto;
    }

    .header-actions {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      flex-wrap: nowrap;
      flex-shrink: 0;
    }

    .mic-toggle {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 6px 12px 6px 8px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.92);
      box-shadow: 0 6px 12px rgba(255, 182, 120, 0.18);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-muted);
      cursor: pointer;
      transition: transform 140ms ease, box-shadow 140ms ease, background 140ms ease, border-color 140ms ease;
      white-space: nowrap;
    }

    .mic-toggle:disabled {
      cursor: not-allowed;
      opacity: 0.6;
      box-shadow: none;
    }

    .mic-toggle:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(255, 182, 120, 0.28);
    }

    .mic-toggle .mic-icon {
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      background: rgba(255, 255, 255, 0.92);
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.7), 0 4px 8px rgba(255, 183, 120, 0.22);
    }

    .mic-toggle svg {
      width: 16px;
      height: 16px;
    }

    .mic-toggle .mic-fill,
    .mic-toggle .mic-stem {
      fill: currentColor;
    }

    .mic-toggle .mic-slash {
      fill: none;
      stroke: currentColor;
      stroke-width: 2;
      stroke-linecap: round;
      opacity: 0;
    }

    .mic-toggle.on {
      color: #0e7b6e;
      border-color: rgba(36, 178, 166, 0.55);
      background: rgba(156, 229, 216, 0.45);
    }

    .mic-toggle.on .mic-icon {
      background: rgba(156, 229, 216, 0.55);
      animation: micPulse 1.8s ease-in-out infinite;
    }

    .mic-toggle.off {
      color: #6a767b;
    }

    .mic-toggle.pending {
      color: #b06a05;
      border-color: rgba(255, 190, 85, 0.7);
      background: rgba(255, 223, 173, 0.55);
    }

    .mic-toggle.blocked {
      color: #b04237;
      border-color: rgba(255, 149, 131, 0.6);
      background: rgba(255, 210, 201, 0.6);
    }

    .mic-toggle.demo {
      color: #2b6ea8;
      border-color: rgba(106, 188, 240, 0.6);
      background: rgba(170, 220, 252, 0.5);
    }

    .mic-toggle.off .mic-slash,
    .mic-toggle.blocked .mic-slash,
    .mic-toggle.demo .mic-slash {
      opacity: 0.85;
    }

    .status-badge {
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.85);
      font-weight: 700;
      letter-spacing: 0.3px;
      min-width: 96px;
      text-align: center;
      cursor: pointer;
      appearance: none;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 6px 12px rgba(255, 182, 120, 0.16);
      transition: transform 140ms ease, box-shadow 140ms ease, opacity 140ms ease, background 140ms ease;
      white-space: nowrap;
    }

    .status-badge.running {
      background: linear-gradient(135deg, rgba(156, 229, 216, 0.55), rgba(94, 204, 190, 0.35));
      color: #0b6f62;
      border-color: rgba(36, 178, 166, 0.55);
    }

    .status-badge.paused {
      background: linear-gradient(135deg, rgba(255, 227, 170, 0.7), rgba(255, 190, 85, 0.4));
      color: #a15a00;
      border-color: rgba(255, 178, 82, 0.6);
    }

    .status-badge.demo {
      background: linear-gradient(135deg, rgba(170, 220, 252, 0.6), rgba(119, 187, 236, 0.35));
      color: #2b5f94;
      border-color: rgba(106, 188, 240, 0.6);
    }

    .status-badge.idle {
      color: var(--text-muted);
    }

    .status-badge:hover:not(:disabled) {
      transform: translateY(-1px);
      box-shadow: 0 10px 18px rgba(255, 182, 120, 0.24);
    }

    .status-badge:disabled {
      cursor: not-allowed;
      opacity: 0.65;
      box-shadow: none;
    }

    .db-readout {
      text-align: right;
      min-width: 140px;
    }

    .db-value {
      font-size: clamp(24px, 3.4vw, 40px);
      font-weight: 700;
      letter-spacing: 1px;
      line-height: 1;
      min-width: 86px;
      text-align: right;
    }

    .db-value span {
      color: var(--accent);
      text-shadow: 0 2px 0 rgba(255, 255, 255, 0.7);
      display: inline-block;
      min-width: 3ch;
      text-align: right;
    }

    .db-diff {
      margin-top: 2px;
      font-size: 12px;
      font-weight: 600;
      white-space: nowrap;
    }

    .db-diff.good {
      color: #1b8e50;
    }

    .db-diff.low {
      color: #cc6b2b;
    }

    .db-diff.neutral {
      color: var(--text-muted);
    }

    main.app-main {
      flex: 1;
      display: grid;
      grid-template-columns: minmax(240px, 320px) 1fr;
      grid-template-rows: minmax(0, 1fr);
      gap: 16px;
      min-height: 0;
    }

    .control-panel {
      display: flex;
      flex-direction: column;
      min-height: 0;
      overflow-x: hidden;
      overflow-y: auto;
      padding-bottom: 12px;
    }

    body.fullscreen #app {
      padding: 12px 16px 16px;
    }

    body.fullscreen header.app-header {
      justify-content: flex-end;
    }

    body.fullscreen .title-block {
      display: none;
    }

    body.fullscreen main.app-main {
      grid-template-columns: 1fr;
    }

    body.fullscreen .control-panel {
      display: none;
    }

    .panel-card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.96), rgba(255, 247, 236, 0.86));
      border: 2px solid rgba(255, 255, 255, 0.85);
      border-radius: var(--radius-lg);
      padding: 14px 16px;
      box-shadow: 0 12px 22px rgba(255, 182, 120, 0.2);
      backdrop-filter: blur(10px);
      animation: fadeIn 600ms ease;
    }

    .panel-card h3 {
      margin: 0 0 10px;
      font-family: var(--font-display);
      font-size: 16px;
      letter-spacing: 0.6px;
    }

    .settings-panel {
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 0 0 auto;
      height: auto;
    }

    .settings-panel:not([open]) {
      height: auto;
    }

    .settings-panel > summary {
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.4px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      list-style: none;
    }

    .settings-panel > summary::-webkit-details-marker {
      display: none;
    }

    .settings-panel > summary::after {
      content: "æŠ˜å ";
      font-size: 12px;
      color: var(--text-muted);
    }

    .settings-panel:not([open]) > summary::after {
      content: "å±•å¼€";
    }

    .settings-body {
      display: flex;
      flex-direction: column;
      gap: 12px;
      flex: 0 0 auto;
      overflow: visible;
      padding-right: 0;
      padding-bottom: 4px;
    }

    .settings-body .panel-card {
      margin: 0;
      border-radius: var(--radius-sm);
      border: 1px solid rgba(255, 255, 255, 0.75);
      background: rgba(255, 255, 255, 0.86);
      box-shadow: 0 6px 16px rgba(255, 182, 120, 0.12);
      backdrop-filter: blur(6px);
      padding: 12px 14px;
    }

    .settings-body .panel-card h3 {
      font-size: 14px;
      margin-bottom: 8px;
    }

    .theme-grid {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .theme-btn {
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(255, 255, 255, 0.9);
      border-radius: 999px;
      padding: 6px 12px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.3px;
      color: var(--text-main);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(255, 247, 236, 0.75));
      box-shadow: 0 10px 18px rgba(255, 182, 120, 0.16);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      white-space: nowrap;
      flex: 0 0 auto;
      transition: transform 160ms ease, border-color 160ms ease, box-shadow 160ms ease, background 160ms ease;
    }

    .theme-btn::after {
      content: "";
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 10%, rgba(255, 255, 255, 0.8), transparent 55%);
      opacity: 0;
      transition: opacity 160ms ease;
      pointer-events: none;
    }

    .theme-icon {
      position: relative;
      width: 28px;
      height: 28px;
      flex: 0 0 28px;
      border-radius: 50%;
      display: inline-grid;
      place-items: center;
      overflow: hidden;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.72), 0 6px 12px rgba(255, 150, 90, 0.22);
      background:
        radial-gradient(circle at 28% 28%, rgba(255, 255, 255, 0.95), rgba(255, 255, 255, 0) 45%),
        var(--ball-fill, linear-gradient(135deg, #ffd5a4, #ff8f5a));
    }

    .theme-icon--plastic {
      --ball-fill: radial-gradient(circle at 60% 70%, #ffd8b8, #ff8f5a 70%);
    }

    .theme-icon--emoji {
      --ball-fill: radial-gradient(circle at 60% 70%, #ffe9b0, #ffbf4a 70%);
    }

    .theme-icon--emoji::before {
      content: "";
      position: absolute;
      width: 4px;
      height: 4px;
      border-radius: 50%;
      background: #7a4a00;
      top: 10px;
      left: 8px;
      box-shadow: 8px 0 0 #7a4a00;
      z-index: 1;
    }

    .theme-icon--emoji::after {
      content: "";
      position: absolute;
      width: 12px;
      height: 6px;
      border-bottom: 2px solid #7a4a00;
      border-radius: 0 0 10px 10px;
      bottom: 7px;
      left: 8px;
      z-index: 1;
    }

    .theme-icon--digit {
      --ball-fill: radial-gradient(circle at 60% 70%, #bfe8ff, #6ec2ff 70%);
    }

    .theme-glyph {
      position: relative;
      z-index: 1;
      font-size: 13px;
      font-weight: 700;
      line-height: 1;
      color: #1f4a73;
      text-shadow: 0 1px 0 rgba(255, 255, 255, 0.85);
    }

    .theme-icon--star {
      --ball-fill: radial-gradient(circle at 60% 70%, #fff0b8, #ffb63b 70%);
    }

    .theme-icon--star::before {
      content: "";
      width: 14px;
      height: 14px;
      background: linear-gradient(180deg, #fff9d1, #ffd76a);
      clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%);
      filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.15));
      z-index: 1;
    }

    .theme-icon--crystal {
      --ball-fill: radial-gradient(circle at 60% 70%, #d6fbf7, #6ccad0 70%);
    }

    .theme-icon--crystal::before {
      content: "";
      width: 14px;
      height: 14px;
      background: linear-gradient(135deg, #e9fffb, #7fd3d3);
      transform: rotate(45deg);
      border-radius: 2px;
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.7);
      z-index: 1;
    }

    .theme-icon--crystal::after {
      content: "";
      position: absolute;
      width: 6px;
      height: 6px;
      background: rgba(255, 255, 255, 0.6);
      top: 9px;
      left: 11px;
      transform: rotate(45deg);
      border-radius: 1px;
      z-index: 2;
    }

    .theme-icon--wave {
      --ball-fill: radial-gradient(circle at 60% 70%, #e8e2ff, #8aa8ff 70%);
    }

    .theme-icon--wave svg {
      width: 20px;
      height: 20px;
      stroke: #2f4a8f;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      opacity: 0.9;
      pointer-events: none;
      z-index: 1;
    }

    .theme-btn:hover {
      transform: translateY(-2px);
      border-color: rgba(36, 178, 166, 0.5);
      box-shadow: 0 14px 22px rgba(255, 182, 120, 0.26);
    }

    .theme-btn:hover::after {
      opacity: 1;
    }

    .theme-btn:focus-visible {
      outline: 2px solid rgba(36, 178, 166, 0.5);
      outline-offset: 2px;
    }

    .theme-btn.active {
      border-color: rgba(255, 122, 61, 0.8);
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.99), rgba(255, 248, 238, 0.76));
      box-shadow: 0 14px 24px rgba(255, 122, 61, 0.3);
      transform: translateY(-2px);
    }

    .theme-btn.active .theme-icon {
      box-shadow: inset 0 0 0 1px rgba(255, 255, 255, 0.75), 0 8px 14px rgba(255, 122, 61, 0.24);
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .control-row label {
      font-size: 14px;
    }

    .value-pill {
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.92);
      border: 2px solid rgba(255, 255, 255, 0.85);
      box-shadow: 0 4px 8px rgba(255, 182, 120, 0.18);
      font-weight: 600;
      min-width: 64px;
      text-align: center;
    }

    input[type="range"] {
      width: 100%;
      appearance: none;
      height: 6px;
      background: linear-gradient(90deg, var(--accent), var(--accent-3) 50%, var(--accent-2));
      border-radius: 999px;
      outline: none;
    }

    input[type="range"]::-webkit-slider-thumb {
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: #fff;
      border: 2px solid rgba(255, 122, 61, 0.7);
      box-shadow: 0 4px 10px rgba(255, 150, 90, 0.28);
      cursor: pointer;
    }

    input[type="number"] {
      width: 84px;
      padding: 6px 8px;
      border-radius: 10px;
      border: 2px solid rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.95);
      font-size: 14px;
    }

    .preset-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .preset-btn {
      padding: 8px 12px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.9);
      box-shadow: 0 6px 12px rgba(255, 182, 120, 0.16);
      cursor: pointer;
      font-size: 13px;
      transition: transform 120ms ease, background 120ms ease, box-shadow 120ms ease;
    }

    .preset-btn:hover {
      transform: translateY(-1px);
      background: rgba(255, 255, 255, 0.98);
      box-shadow: 0 8px 16px rgba(255, 182, 120, 0.24);
    }

    .demo-toggle {
      min-width: 120px;
      text-align: center;
    }

    .demo-toggle.active {
      background: linear-gradient(135deg, rgba(255, 167, 111, 0.95), rgba(255, 115, 72, 0.9));
      color: #fff;
      border-color: rgba(255, 130, 86, 0.6);
      box-shadow: 0 10px 18px rgba(255, 122, 61, 0.3);
    }

    .demo-toggle:disabled {
      cursor: not-allowed;
      opacity: 0.65;
      box-shadow: none;
    }

    .combo-settings {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(255, 255, 255, 0.78);
      border: 2px dashed rgba(255, 174, 120, 0.45);
    }

    .combo-settings summary {
      cursor: pointer;
      font-weight: 700;
      letter-spacing: 0.3px;
      list-style: none;
    }

    .combo-settings summary::-webkit-details-marker {
      display: none;
    }

    .combo-settings summary::after {
      content: "è®¾ç½®";
      margin-left: 6px;
      font-size: 12px;
      color: var(--text-muted);
    }

    .combo-settings[open] summary::after {
      content: "æ”¶èµ·";
    }

    .combo-grid {
      margin-top: 10px;
      display: grid;
      gap: 8px;
    }

    .combo-actions {
      display: flex;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .combo-actions .note-text {
      margin: 0;
    }

    .btn-group {
      display: grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap: 10px;
    }

    .action-btn {
      padding: 12px 10px;
      border-radius: 18px;
      border: none;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, opacity 120ms ease;
    }

    .action-btn.compact {
      padding: 8px 12px;
      border-radius: 999px;
      font-size: 13px;
      min-width: 72px;
    }

    .action-btn.primary {
      background: linear-gradient(135deg, #ff9a5f, #ff6b3d);
      color: #fff;
      box-shadow: 0 12px 24px rgba(255, 107, 61, 0.38);
    }

    .action-btn.secondary {
      background: rgba(255, 255, 255, 0.92);
      border: 2px solid rgba(255, 186, 118, 0.35);
    }

    .action-btn.ghost {
      background: rgba(255, 255, 255, 0.65);
      border: 2px dashed rgba(255, 150, 92, 0.35);
      color: var(--text-muted);
    }

    .action-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      box-shadow: none;
    }

    .action-btn:not(:disabled):hover {
      transform: translateY(-1px);
    }

    .stage-panel {
      position: relative;
      border-radius: 30px;
      overflow: hidden;
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.9), rgba(184, 240, 231, 0.45));
      border: 2px solid rgba(255, 255, 255, 0.9);
      box-shadow: 0 18px 34px rgba(255, 182, 120, 0.24);
      height: 100%;
      min-height: 0;
    }

    canvas#stage {
      width: 100%;
      height: 100%;
      display: block;
    }

    .stage-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      pointer-events: none;
      padding: 18px;
      text-align: center;
      font-family: var(--font-display);
      color: rgba(29, 38, 45, 0.75);
      font-size: 18px;
      font-weight: 600;
      text-shadow: 0 2px 10px rgba(255, 255, 255, 0.9);
    }

    .combo-text {
      position: absolute;
      top: 16px;
      left: 0;
      right: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      pointer-events: none;
      opacity: 0;
      transform: translateY(-6px) scale(0.96);
      transition: opacity 200ms ease, transform 200ms ease;
      text-shadow: 0 4px 12px rgba(255, 255, 255, 0.9);
    }

    .combo-text.active {
      opacity: 1;
      transform: translateY(0) scale(1);
      animation: comboFlash 420ms ease;
    }

    .combo-line {
      padding: 4px 12px;
      border-radius: 999px;
      border: 2px solid rgba(255, 255, 255, 0.85);
      background: rgba(255, 255, 255, 0.92);
      font-weight: 700;
      letter-spacing: 0.6px;
      box-shadow: 0 10px 18px rgba(255, 122, 61, 0.25);
    }

    .combo-primary {
      font-size: clamp(18px, 2.4vw, 26px);
      color: #ff6b3d;
    }

    .combo-secondary {
      font-size: clamp(13px, 1.9vw, 18px);
      color: #1f6f66;
      background: rgba(255, 248, 235, 0.95);
    }

    .combo-text.tier-1 .combo-primary {
      color: #ff7a3d;
    }

    .combo-text.tier-2 .combo-primary {
      color: #ffb703;
    }

    .combo-text.tier-3 .combo-primary {
      color: #22b978;
    }

    .combo-text.tier-3 .combo-secondary {
      color: #0f6c57;
      background: rgba(255, 238, 204, 0.98);
    }

    .hint {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      position: relative;
      padding: 10px 18px;
      border-radius: 999px;
      max-width: min(90%, 520px);
      background: linear-gradient(135deg, rgba(255, 167, 111, 0.98), rgba(255, 108, 72, 0.96));
      border: 2px solid rgba(255, 255, 255, 0.85);
      box-shadow: 0 16px 28px rgba(255, 108, 72, 0.28);
      color: #fff;
      font-size: clamp(16px, 2.2vw, 22px);
      font-weight: 700;
      letter-spacing: 0.6px;
      line-height: 1.4;
      text-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
      opacity: 1;
      transform: translateY(0);
      transition: opacity 180ms ease, transform 180ms ease;
      will-change: opacity, transform;
    }

    .hint::before {
      content: "";
      position: absolute;
      inset: -10px;
      border-radius: 999px;
      background: radial-gradient(circle, rgba(255, 146, 90, 0.45), rgba(255, 146, 90, 0) 70%);
      opacity: 0.8;
      filter: blur(6px);
      animation: hintGlow 1.4s ease-in-out infinite;
      pointer-events: none;
      z-index: -1;
    }

    .hint-text {
      display: inline-block;
      animation: hintPulse 1.1s ease-in-out infinite;
    }

    .hint.hidden .hint-text {
      animation: none;
    }

    .hint.hidden {
      opacity: 0;
      transform: translateY(6px);
    }

    .hint.hidden::before {
      animation: none;
      opacity: 0;
    }

    .note-text {
      font-size: 13px;
      color: var(--text-muted);
      line-height: 1.5;
    }

    .demo-panel {
      display: none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 243, 224, 0.75);
      border: 2px dashed rgba(255, 174, 120, 0.45);
    }

    .demo-panel.active {
      display: block;
    }

    body.hide-demo .demo-row,
    body.hide-demo .demo-panel {
      display: none !important;
    }

    .demo-panel .control-row {
      margin-top: 6px;
    }

    .calibration-result {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255, 255, 255, 0.9);
      border: 2px solid rgba(255, 255, 255, 0.85);
      display: none;
      font-size: 13px;
      line-height: 1.5;
    }

    .calibration-result.active {
      display: block;
    }

    .calibration-result button {
      margin-top: 8px;
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: none;
      background: linear-gradient(135deg, #2fc1b2, #1a9f90);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }

    .modal {
      position: fixed;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      background: rgba(18, 24, 28, 0.35);
      z-index: 10;
      padding: 20px;
    }

    .modal.active {
      display: flex;
    }

    .modal-card {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.98), rgba(255, 244, 231, 0.9));
      padding: 20px;
      border-radius: 20px;
      max-width: 420px;
      width: 100%;
      text-align: center;
      box-shadow: 0 20px 40px rgba(255, 182, 120, 0.3);
    }

    .modal-card h4 {
      margin: 0 0 8px;
      font-family: var(--font-display);
      font-size: 18px;
    }

    .modal-card p {
      margin: 0;
      color: var(--text-muted);
      font-size: 14px;
    }

    .review-card {
      position: relative;
      padding: 22px 22px 20px;
    }

    .review-card h3 {
      margin: 0 0 8px;
      font-family: var(--font-display);
      font-size: 20px;
      letter-spacing: 0.4px;
    }

    .review-card p {
      margin: 0 0 16px;
      color: var(--text-muted);
      font-size: 14px;
      line-height: 1.6;
    }

    .review-card .action-btn {
      width: 100%;
      justify-content: center;
    }

    .modal-close {
      position: absolute;
      top: 10px;
      right: 12px;
      width: 28px;
      height: 28px;
      border-radius: 50%;
      border: none;
      background: rgba(255, 255, 255, 0.85);
      color: var(--text-muted);
      font-size: 16px;
      cursor: pointer;
      display: grid;
      place-items: center;
      box-shadow: 0 6px 12px rgba(255, 182, 120, 0.18);
    }

    .modal-close:hover {
      color: var(--text-main);
    }

    .progress {
      height: 8px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.7);
      overflow: hidden;
      margin-top: 16px;
    }

    .progress span {
      display: block;
      height: 100%;
      width: 0;
      background: linear-gradient(90deg, var(--accent), var(--accent-3), var(--accent-2));
      transition: width 200ms ease;
    }

    @keyframes floatIn {
      from {
        opacity: 0;
        transform: translateY(12px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(8px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes titlePop {
      0% {
        opacity: 0;
        transform: translateY(6px) scale(0.96);
      }
      60% {
        opacity: 1;
        transform: translateY(-2px) scale(1.02);
      }
      100% {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    @keyframes comboFlash {
      0% {
        transform: translateY(-6px) scale(0.96);
      }
      60% {
        transform: translateY(2px) scale(1.05);
      }
      100% {
        transform: translateY(0) scale(1);
      }
    }

    @keyframes hintPulse {
      0%,
      100% {
        transform: scale(1);
      }
      50% {
        transform: scale(1.06);
      }
    }

    @keyframes hintGlow {
      0%,
      100% {
        transform: scale(0.98);
        opacity: 0.6;
      }
      50% {
        transform: scale(1.08);
        opacity: 1;
      }
    }

    @keyframes iconBounce {
      0%,
      100% {
        transform: translateY(0) rotate(0deg);
      }
      50% {
        transform: translateY(-3px) rotate(-2deg);
      }
    }

    @keyframes floatBubbles {
      from {
        transform: translateY(0);
      }
      to {
        transform: translateY(-14px);
      }
    }

    @keyframes micPulse {
      0% {
        box-shadow: 0 0 0 0 rgba(36, 178, 166, 0.35);
      }
      70% {
        box-shadow: 0 0 0 10px rgba(36, 178, 166, 0);
      }
      100% {
        box-shadow: 0 0 0 0 rgba(36, 178, 166, 0);
      }
    }

    @media (max-width: 980px) {
      header.app-header {
        flex-wrap: wrap;
      }

      main.app-main {
        grid-template-columns: 1fr;
        grid-template-rows: auto 1fr;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      .control-panel {
        min-height: auto;
        overflow: visible;
      }

      .settings-panel {
        height: auto;
      }

      .settings-body {
        overflow: visible;
        padding-right: 0;
      }

      .status-block {
        flex-wrap: wrap;
        white-space: normal;
      }
    }

    @media (max-width: 640px) {
      #app {
        padding: 16px;
      }

      .status-block {
        width: 100%;
        justify-content: flex-start;
      }

      .header-actions {
        width: 100%;
        justify-content: flex-start;
        flex-wrap: wrap;
      }
    }
  </style>
</head>
<body class="hide-demo">
  <div id="app">
    <header class="app-header">
      <div class="title-block">
        <span class="title-icon" aria-hidden="true"></span>
        <div class="title-text">
          <h1>æ—©è¯»å£°æ§çƒ</h1>
          <p>æ—©è¯»å£°éŸ³è¶Šå“äº®ï¼Œå°çƒè·³çš„è¶Šé«˜ã€‚è®©è¯¾å ‚éŸ³é‡å³æ—¶å¯è§†åŒ–ã€‚</p>
        </div>
      </div>
      <div class="status-block">
        <button id="micToggle" class="mic-toggle off" type="button" aria-pressed="false">
          <span class="mic-icon" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <path class="mic-fill" d="M12 14a3 3 0 0 0 3-3V6a3 3 0 1 0-6 0v5a3 3 0 0 0 3 3z"></path>
              <path class="mic-stem" d="M19 11a1 1 0 0 0-2 0 5 5 0 0 1-10 0 1 1 0 1 0-2 0 7 7 0 0 0 6 6.92V21a1 1 0 0 0 2 0v-3.08A7 7 0 0 0 19 11z"></path>
              <path class="mic-slash" d="M4 4l16 16"></path>
            </svg>
          </span>
          <span id="micLabel">éº¦å…‹é£æœªå¼€å¯</span>
        </button>
        <button id="statusBadge" class="status-badge idle" type="button">æœªå¼€å§‹</button>
        <div class="db-readout">
          <div class="db-value"><span id="currentDb">--</span> dB</div>
          <div id="dbDiff" class="db-diff neutral">é˜ˆå€¼å·® --</div>
        </div>
        <div class="header-actions">
          <button id="startBtn" class="action-btn primary compact" type="button">å¼€å§‹</button>
          <button id="pauseBtn" class="action-btn secondary compact" type="button" disabled>æš‚åœ</button>
          <button id="resetBtn" class="action-btn ghost compact" type="button" disabled>é‡ç½®</button>
          <button id="fullscreenToggle" class="action-btn secondary compact" type="button" aria-pressed="false">è¿›å…¥å…¨å±</button>
        </div>
      </div>
    </header>

    <main class="app-main">
      <section class="control-panel">
        <div class="panel-card">
          <h3>ä¸»é¢˜é€‰æ‹©</h3>
          <div class="theme-grid" id="themeGrid">
            <button class="theme-btn active" data-theme="plastic" type="button">
              <span class="theme-icon theme-icon--plastic" aria-hidden="true"></span>
              å¡‘æ–™çƒ
            </button>
            <button class="theme-btn" data-theme="emoji" type="button">
              <span class="theme-icon theme-icon--emoji" aria-hidden="true"></span>
              è¡¨æƒ…ç¬¦å·çƒ
            </button>
            <button class="theme-btn" data-theme="digit" type="button">
              <span class="theme-icon theme-icon--digit" aria-hidden="true">
                <span class="theme-glyph">8</span>
              </span>
              æ•°å­—çƒ
            </button>
            <button class="theme-btn" data-theme="star" type="button">
              <span class="theme-icon theme-icon--star" aria-hidden="true"></span>
              æ˜Ÿæ˜Ÿ
            </button>
            <button class="theme-btn" data-theme="crystal" type="button">
              <span class="theme-icon theme-icon--crystal" aria-hidden="true"></span>
              æ°´æ™¶çƒ
            </button>
            <button class="theme-btn" data-theme="wave" type="button">
              <span class="theme-icon theme-icon--wave" aria-hidden="true">
                <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false">
                  <path d="M2 9c2.3-2.6 4.7-2.6 7 0s4.7 2.6 7 0 4.7-2.6 6 0"></path>
                  <path d="M2 15c2.3-2.6 4.7-2.6 7 0s4.7 2.6 7 0 4.7-2.6 6 0"></path>
                </svg>
              </span>
              éŸ³æµªçƒ
            </button>
          </div>
        </div>
        <details class="panel-card settings-panel" open>
          <summary>ç®€åŒ–è®¾ç½®</summary>
          <div class="settings-body">
            <div class="panel-card">
              <h3>çƒæ•°é‡</h3>
              <div class="control-row">
                <label for="ballCount">å½“å‰æ•°é‡</label>
                <div class="value-pill" id="ballCountValue">20</div>
              </div>
              <input id="ballCount" type="range" min="1" max="60" value="20" />
              <p class="note-text">å»ºè®®åœ¨å¤§å±ä¸Šä¿æŒ 12 - 36 ä¸ªï¼Œç”»é¢æ›´èˆ’å±•ã€‚</p>
            </div>

            <div class="panel-card">
              <h3>åˆ†è´é˜ˆå€¼</h3>
              <div class="control-row">
                <label for="thresholdRange">é˜ˆå€¼ (dB)</label>
                <div class="value-pill" id="thresholdValue">55</div>
              </div>
              <input id="thresholdRange" type="range" min="30" max="90" value="55" />
              <div class="control-row" style="margin-top: 8px;">
                <label for="thresholdInput">ç²¾ç¡®è¾“å…¥</label>
                <input id="thresholdInput" type="number" min="30" max="90" value="55" />
              </div>
              <div class="preset-group">
                <button class="preset-btn" data-value="45" type="button">å®‰é™ 45</button>
                <button class="preset-btn" data-value="55" type="button">åˆæ ¼ 55</button>
                <button class="preset-btn" data-value="65" type="button">æ´ªäº® 65</button>
              </div>
            </div>

            <div class="panel-card">
              <h3>æ§åˆ¶åŒº</h3>
              <div class="control-row demo-row" style="margin-bottom: 8px;">
                <label>æ¼”ç¤ºæ¨¡å¼</label>
                <button id="demoToggle" class="preset-btn demo-toggle" type="button">å·²å…³é—­</button>
              </div>
              <div id="demoPanel" class="demo-panel">
                <strong>æ¼”ç¤ºæ¨¡å¼</strong>
                <div class="control-row">
                  <label for="demoRange">æ¨¡æ‹ŸéŸ³é‡</label>
                  <div class="value-pill" id="demoValue">55</div>
                </div>
                <input id="demoRange" type="range" min="30" max="90" value="55" />
                <p class="note-text">å·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ï¼Œå¯æ‹–åŠ¨æ»‘å—æ¨¡æ‹Ÿ dBã€‚</p>
              </div>
              <p id="notice" class="note-text" style="margin-top: 10px;"></p>
            </div>

            <div class="panel-card">
              <h3>è¿å‡»æ•ˆæœ</h3>
              <p id="comboSummary" class="note-text">ä¿æŒå¤§å£°å¯è§¦å‘è¿å‡»ä¸çƒŸèŠ±æ•ˆæœã€‚</p>
              <details class="combo-settings">
                <summary>é«˜çº§è®¾ç½®</summary>
                <div class="combo-grid">
                  <div class="control-row">
                    <label for="comboLow">ä½æ®µé˜ˆå€¼ï¼ˆ+dBï¼‰</label>
                    <input id="comboLow" type="number" min="1" max="20" step="1" />
                  </div>
                  <div class="control-row">
                    <label for="comboMid">ä¸­æ®µé˜ˆå€¼ï¼ˆ+dBï¼‰</label>
                    <input id="comboMid" type="number" min="2" max="25" step="1" />
                  </div>
                  <div class="control-row">
                    <label for="comboHigh">é«˜æ®µé˜ˆå€¼ï¼ˆ+dBï¼‰</label>
                    <input id="comboHigh" type="number" min="3" max="30" step="1" />
                  </div>
                  <div class="control-row">
                    <label for="comboSustain">æŒç»­æ—¶é—´ï¼ˆç§’ï¼‰</label>
                    <input id="comboSustain" type="number" min="0.3" max="5" step="0.1" />
                  </div>
                  <div class="combo-actions">
                    <button id="comboReset" class="preset-btn" type="button">æ¢å¤é»˜è®¤</button>
                    <p class="note-text">è®¾ç½®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨</p>
                  </div>
                </div>
              </details>
            </div>

            <div class="panel-card">
              <h3>æ ¡å‡†/è¯•å¬</h3>
              <p class="note-text">ç‚¹å‡»æ ¡å‡†åï¼Œè¯·å…ˆå®‰é™ 2 ç§’ï¼Œå†æœ—è¯» 3 ç§’ã€‚</p>
              <button id="calibrateBtn" class="action-btn secondary" type="button">å¼€å§‹æ ¡å‡†</button>
              <div id="calibrationResult" class="calibration-result"></div>
            </div>
          </div>
        </details>
      </section>

      <section class="stage-panel">
        <canvas id="stage"></canvas>
        <div class="stage-overlay">
        <div id="hintText" class="hint"><span class="hint-text">ç‚¹å‡»å¼€å§‹è·å–éº¦å…‹é£æƒé™</span></div>
        </div>
        <div id="comboText" class="combo-text" aria-live="polite"></div>
      </section>
    </main>
  </div>

  <div id="calibrationModal" class="modal">
    <div class="modal-card">
      <h4 id="modalTitle">æ ¡å‡†ä¸­</h4>
      <p id="modalDesc">è¯·ä¿æŒå®‰é™</p>
      <div class="progress"><span id="modalProgress"></span></div>
    </div>
  </div>

  <div id="reviewModal" class="modal" aria-hidden="true">
    <div class="modal-card review-card" role="dialog" aria-modal="true" aria-labelledby="reviewTitle" aria-describedby="reviewDesc">
      <button id="reviewClose" class="modal-close" type="button" aria-label="å…³é—­">Ã—</button>
      <h3 id="reviewTitle">ğŸ å¥½è¯„æœ‰ç¤¼</h3>
      <p id="reviewDesc">ç»™ä¸ªäº”æ˜Ÿå¥½è¯„æˆªå›¾å‘å®¢æœ<br />å…è´¹é¢†å–åº—å†…ä»»æ„ä¸€æ¬¾äº§å“ï¼</p>
      <button id="reviewOk" class="action-btn primary" type="button">æˆ‘çŸ¥é“äº†</button>
    </div>
  </div>

  <script>
    (() => {
      "use strict";

      const DEFAULTS = {
        theme: "plastic",
        ballCount: 20,
        thresholdDb: 55,
        minDb: 35,
        maxDb: 80,
        smoothing: 0.15,
        dbOffset: 100
      };

      const COMBO_STORAGE_KEY = "zaodu_combo_settings";
      const COMBO_DEFAULTS = {
        offsetLow: 4,
        offsetMid: 8,
        offsetHigh: 12,
        sustainMs: 700
      };
      const COMBO_MESSAGES = {
        1: "è¿å‡»Ã—{count}ï¼ä¿æŒèŠ‚å¥ï¼",
        2: "è¿å‡»Ã—{count}ï¼ç«åŠ›å…¨å¼€ï¼",
        3: "è¿å‡»Ã—{count}ï¼ä¼ å¥‡é™ä¸´ï¼"
      };

      const state = {
        theme: DEFAULTS.theme,
        ballCount: DEFAULTS.ballCount,
        thresholdDb: DEFAULTS.thresholdDb,
        minDb: DEFAULTS.minDb,
        maxDb: DEFAULTS.maxDb,
        smoothing: DEFAULTS.smoothing,
        dbOffset: DEFAULTS.dbOffset,
        running: false,
        paused: false,
        demoMode: false,
        demoLocked: false,
        audioSupported: true,
        micPending: false,
        micDenied: false,
        currentDb: DEFAULTS.thresholdDb,
        smoothDb: DEFAULTS.thresholdDb,
        rawDb: DEFAULTS.thresholdDb,
        demoDb: DEFAULTS.thresholdDb,
        calibrating: false,
        lowVolumeHintActive: false,
        lowVolumeSince: null,
        highVolumeSince: null,
        loudSince: null,
        lastFireworkAt: 0,
        comboCount: 0,
        comboLastAt: 0,
        comboTier: 0,
        loudTier: 0,
        comboSettings: { ...COMBO_DEFAULTS },
        lastFrame: 0,
        canvasWidth: 0,
        canvasHeight: 0,
        canvasRatio: window.devicePixelRatio || 1,
        stream: null,
        audioCtx: null,
        analyser: null,
        dataArray: null,
        sampleTimer: null
      };

      const ui = {
        stage: document.getElementById("stage"),
        themeGrid: document.getElementById("themeGrid"),
        ballCount: document.getElementById("ballCount"),
        ballCountValue: document.getElementById("ballCountValue"),
        thresholdRange: document.getElementById("thresholdRange"),
        thresholdInput: document.getElementById("thresholdInput"),
        thresholdValue: document.getElementById("thresholdValue"),
        comboSummary: document.getElementById("comboSummary"),
        comboLow: document.getElementById("comboLow"),
        comboMid: document.getElementById("comboMid"),
        comboHigh: document.getElementById("comboHigh"),
        comboSustain: document.getElementById("comboSustain"),
        comboReset: document.getElementById("comboReset"),
        presetButtons: document.querySelectorAll(".preset-btn[data-value]"),
        demoToggle: document.getElementById("demoToggle"),
        fullscreenToggle: document.getElementById("fullscreenToggle"),
        startBtn: document.getElementById("startBtn"),
        pauseBtn: document.getElementById("pauseBtn"),
        resetBtn: document.getElementById("resetBtn"),
        micToggle: document.getElementById("micToggle"),
        micLabel: document.getElementById("micLabel"),
        statusBadge: document.getElementById("statusBadge"),
        currentDb: document.getElementById("currentDb"),
        dbDiff: document.getElementById("dbDiff"),
        hintText: document.getElementById("hintText"),
        comboText: document.getElementById("comboText"),
        notice: document.getElementById("notice"),
        demoPanel: document.getElementById("demoPanel"),
        demoRange: document.getElementById("demoRange"),
        demoValue: document.getElementById("demoValue"),
        calibrateBtn: document.getElementById("calibrateBtn"),
        calibrationResult: document.getElementById("calibrationResult"),
        modal: document.getElementById("calibrationModal"),
        modalTitle: document.getElementById("modalTitle"),
        modalDesc: document.getElementById("modalDesc"),
        modalProgress: document.getElementById("modalProgress"),
        reviewModal: document.getElementById("reviewModal"),
        reviewClose: document.getElementById("reviewClose"),
        reviewOk: document.getElementById("reviewOk")
      };

      const ctx = ui.stage.getContext("2d");
      const balls = [];
      const fireworks = [];
      const floaties = [];
      let resizeFrame = null;
      const emojiList = ["ğŸ˜€", "ğŸ˜„", "ğŸ˜", "ğŸ“š", "ğŸŒŸ", "ğŸˆ", "ğŸ¦Š", "ğŸ±", "ğŸ§ ", "ğŸš€", "ğŸ€", "ğŸ¯"];
      const palette = [
        ["#ffb482", "#ff7a2f"],
        ["#ffd97a", "#ffb347"],
        ["#98e1dd", "#3db8b0"],
        ["#a6d8ff", "#5ba3f6"],
        ["#ffc9e1", "#f175b3"],
        ["#fbe28c", "#f3b948"]
      ];
      const candyColors = ["#ff8fab", "#ffd166", "#a0c4ff", "#bdb2ff", "#caffbf", "#ffcad4"];
      const starColors = ["#ffe066", "#ffd6ff", "#bde0fe", "#caffbf", "#ffd6a5"];
      const ribbonColors = ["#ff6b6b", "#ffb703", "#4cc9f0", "#57cc99", "#f8961e", "#f15bb5"];
      const bubbleColors = ["#9be7ff", "#b8f2e6", "#ffd6a5"];
      const REVIEW_POPUP_KEY = "reviewPopupShown";
      const REVIEW_DELAY_MIN = 3 * 60 * 1000;
      const REVIEW_DELAY_MAX = 5 * 60 * 1000;
      let reviewTimer = null;

      function clamp(value, min, max) {
        return Math.min(Math.max(value, min), max);
      }

      function lerp(a, b, t) {
        return a + (b - a) * t;
      }

      function sanitizeComboSettings(raw) {
        const low = clamp(Number(raw.offsetLow) || COMBO_DEFAULTS.offsetLow, 1, 20);
        const mid = clamp(Number(raw.offsetMid) || COMBO_DEFAULTS.offsetMid, low + 1, 26);
        const high = clamp(Number(raw.offsetHigh) || COMBO_DEFAULTS.offsetHigh, mid + 1, 32);
        const sustainMs = clamp(Number(raw.sustainMs) || COMBO_DEFAULTS.sustainMs, 300, 5000);
        return {
          offsetLow: Math.round(low),
          offsetMid: Math.round(mid),
          offsetHigh: Math.round(high),
          sustainMs: Math.round(sustainMs)
        };
      }

      function loadComboSettings() {
        try {
          const stored = window.localStorage.getItem(COMBO_STORAGE_KEY);
          if (!stored) {
            return { ...COMBO_DEFAULTS };
          }
          const parsed = JSON.parse(stored);
          return sanitizeComboSettings(parsed || {});
        } catch (error) {
          return { ...COMBO_DEFAULTS };
        }
      }

      function saveComboSettings(settings) {
        try {
          window.localStorage.setItem(COMBO_STORAGE_KEY, JSON.stringify(settings));
        } catch (error) {
          // Ignore storage failures (private mode).
        }
      }

      function updateComboSettingsUI() {
        if (!ui.comboLow) {
          return;
        }
        ui.comboLow.value = String(state.comboSettings.offsetLow);
        ui.comboMid.value = String(state.comboSettings.offsetMid);
        ui.comboHigh.value = String(state.comboSettings.offsetHigh);
        ui.comboSustain.value = String((state.comboSettings.sustainMs / 1000).toFixed(1));
      }

      function updateComboSummary() {
        if (!ui.comboSummary) {
          return;
        }
        const settings = state.comboSettings;
        const low = state.thresholdDb + settings.offsetLow;
        const mid = state.thresholdDb + settings.offsetMid;
        const high = state.thresholdDb + settings.offsetHigh;
        ui.comboSummary.textContent = `ä½æ®µ â‰¥${low} dBï¼Œä¸­æ®µ â‰¥${mid} dBï¼Œé«˜æ®µ â‰¥${high} dBï¼ˆæŒç»­ ${(settings.sustainMs / 1000).toFixed(1)} ç§’ï¼‰`;
      }

      function applyComboSettings(settings) {
        state.comboSettings = sanitizeComboSettings(settings);
        updateComboSettingsUI();
        updateComboSummary();
        saveComboSettings(state.comboSettings);
      }

      function handleComboInput() {
        if (!ui.comboLow) {
          return;
        }
        const settings = sanitizeComboSettings({
          offsetLow: ui.comboLow.value,
          offsetMid: ui.comboMid.value,
          offsetHigh: ui.comboHigh.value,
          sustainMs: Number(ui.comboSustain.value) * 1000
        });
        state.comboSettings = settings;
        updateComboSettingsUI();
        updateComboSummary();
        saveComboSettings(settings);
      }

      function resetComboSettings() {
        applyComboSettings({ ...COMBO_DEFAULTS });
      }

      function getComboThresholds() {
        const settings = state.comboSettings;
        return [
          state.thresholdDb + settings.offsetLow,
          state.thresholdDb + settings.offsetMid,
          state.thresholdDb + settings.offsetHigh
        ];
      }

      function getComboTier(db) {
        const [low, mid, high] = getComboThresholds();
        if (db >= high) {
          return 3;
        }
        if (db >= mid) {
          return 2;
        }
        if (db >= low) {
          return 1;
        }
        return 0;
      }

      function getComboTierConfig(tier) {
        if (tier === 3) {
          return { intervalMs: 210, intensity: 1.4 };
        }
        if (tier === 2) {
          return { intervalMs: 260, intensity: 1.15 };
        }
        return { intervalMs: 320, intensity: 1.0 };
      }

      function setNotice(text) {
        ui.notice.textContent = text || "";
      }

      function setHint(text) {
        const hintSpan = ui.hintText.querySelector(".hint-text");
        if (hintSpan) {
          hintSpan.textContent = text;
        } else {
          ui.hintText.textContent = text;
        }
        ui.hintText.classList.toggle("hidden", !text);
      }

      function setStatus(type, text) {
        ui.statusBadge.className = `status-badge ${type}`;
        ui.statusBadge.textContent = text;
        ui.statusBadge.disabled = state.calibrating || state.micPending;
        updateStatusActionHint();
      }

      function updateStatusActionHint() {
        let title = "ç‚¹å‡»å¼€å§‹";
        if (state.running && state.paused) {
          title = "ç‚¹å‡»ç»§ç»­";
        } else if (state.running && !state.paused) {
          title = "ç‚¹å‡»æš‚åœ";
        }
        ui.statusBadge.title = title;
      }

      function updateDbDisplay(db) {
        if (!Number.isFinite(db)) {
          ui.currentDb.textContent = "--";
          ui.dbDiff.textContent = "é˜ˆå€¼å·® --";
          ui.dbDiff.className = "db-diff neutral";
          return;
        }
        const rounded = Math.round(db);
        ui.currentDb.textContent = String(rounded);
        const diff = rounded - state.thresholdDb;
        if (diff === 0) {
          ui.dbDiff.textContent = "åˆšå¥½è¾¾æ ‡";
          ui.dbDiff.className = "db-diff neutral";
        } else if (diff > 0) {
          ui.dbDiff.textContent = `è¶…è¿‡é˜ˆå€¼ +${diff}`;
          ui.dbDiff.className = "db-diff good";
        } else {
          ui.dbDiff.textContent = `ä½äºé˜ˆå€¼ ${Math.abs(diff)}`;
          ui.dbDiff.className = "db-diff low";
        }
        updateReadingHint();
      }

      function updateComboText(count, tier) {
        if (!ui.comboText) {
          return;
        }
        if (!count) {
          ui.comboText.className = "combo-text";
          ui.comboText.textContent = "";
          return;
        }
        const safeTier = tier || 1;
        const headline = `COMBOÃ—${count}`;
        const template = COMBO_MESSAGES[safeTier] || COMBO_MESSAGES[1];
        const tagline = template.replace("{count}", String(count));
        ui.comboText.innerHTML = `
          <div class="combo-line combo-primary">${headline}</div>
          <div class="combo-line combo-secondary">${tagline}</div>
        `;
        ui.comboText.className = `combo-text tier-${safeTier}`;
        ui.comboText.classList.remove("active");
        requestAnimationFrame(() => {
          ui.comboText.classList.add("active");
        });
      }

      function refreshJumpPreview() {
        if (state.running && !state.paused && !state.calibrating) {
          return;
        }
        if (!balls.length) {
          return;
        }
        balls.forEach((ball) => {
          ball.targetJump = computeTargetJump(state.smoothDb, ball);
          ball.jump = ball.targetJump;
        });
        render();
      }

      function updateReadingHint() {
        if (!state.running || state.paused || state.calibrating) {
          state.lowVolumeHintActive = false;
          state.lowVolumeSince = null;
          state.highVolumeSince = null;
          return;
        }
        const showBelowDb = 60;
        const showDurationMs = 3000;
        const hideDurationMs = 600;
        const now = performance.now();

        if (state.smoothDb < showBelowDb) {
          state.highVolumeSince = null;
          if (state.lowVolumeSince === null) {
            state.lowVolumeSince = now;
          }
          if (!state.lowVolumeHintActive && now - state.lowVolumeSince >= showDurationMs) {
            setHint("åŒå­¦ä»¬å£°éŸ³å¤ªå°å•¦ï¼Œå¤§ç‚¹å£°ï¼");
            state.lowVolumeHintActive = true;
          }
          return;
        }

        state.lowVolumeSince = null;
        if (state.smoothDb >= showBelowDb) {
          if (state.highVolumeSince === null) {
            state.highVolumeSince = now;
          }
          if (state.lowVolumeHintActive && now - state.highVolumeSince >= hideDurationMs) {
            setHint("");
            state.lowVolumeHintActive = false;
          }
        } else {
          state.highVolumeSince = null;
        }
      }

      function updateControls() {
        ui.ballCount.value = state.ballCount;
        ui.ballCountValue.textContent = String(state.ballCount);
        ui.thresholdRange.value = state.thresholdDb;
        ui.thresholdInput.value = state.thresholdDb;
        ui.thresholdValue.textContent = String(state.thresholdDb);
        ui.demoRange.value = state.demoDb;
        ui.demoValue.textContent = String(state.demoDb);
        ui.pauseBtn.textContent = state.paused ? "ç»§ç»­" : "æš‚åœ";
        updateComboSummary();
      }

      function activateTheme(theme) {
        state.theme = theme;
        ui.themeGrid.querySelectorAll(".theme-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.theme === theme);
        });
        scheduleResize();
      }

      function updateDemoPanel() {
        ui.demoPanel.classList.toggle("active", state.demoMode);
        updateDemoToggle();
      }

      function updateDemoToggle() {
        if (!ui.demoToggle) {
          return;
        }
        if (state.demoLocked) {
          ui.demoToggle.textContent = "å·²é”å®š";
          ui.demoToggle.disabled = true;
          ui.demoToggle.classList.add("active");
          ui.demoToggle.setAttribute("aria-pressed", "true");
          ui.demoToggle.title = "æ¼”ç¤ºæ¨¡å¼å·²é”å®š";
          return;
        }
        ui.demoToggle.disabled = false;
        ui.demoToggle.classList.toggle("active", state.demoMode);
        ui.demoToggle.setAttribute("aria-pressed", state.demoMode ? "true" : "false");
        ui.demoToggle.textContent = state.demoMode ? "å·²å¼€å¯" : "ç‚¹å‡»å¼€å¯";
        ui.demoToggle.title = state.demoMode ? "ç‚¹å‡»å…³é—­æ¼”ç¤ºæ¨¡å¼" : "ç‚¹å‡»å¼€å¯æ¼”ç¤ºæ¨¡å¼";
      }

      function fullscreenSupported() {
        return Boolean(
          document.fullscreenEnabled ||
          document.webkitFullscreenEnabled ||
          document.documentElement.requestFullscreen ||
          document.documentElement.webkitRequestFullscreen
        );
      }

      function getFullscreenElement() {
        return document.fullscreenElement || document.webkitFullscreenElement;
      }

      function isFullscreen() {
        return Boolean(getFullscreenElement());
      }

      function requestFullscreen(target) {
        const request = target.requestFullscreen || target.webkitRequestFullscreen;
        if (!request) {
          return Promise.reject(new Error("Fullscreen not supported"));
        }
        return request.call(target);
      }

      function exitFullscreen() {
        const exit = document.exitFullscreen || document.webkitExitFullscreen;
        if (!exit) {
          return Promise.reject(new Error("Fullscreen not supported"));
        }
        return exit.call(document);
      }

      function updateFullscreenUI() {
        const active = isFullscreen();
        document.body.classList.toggle("fullscreen", active);
        if (!ui.fullscreenToggle) {
          resizeCanvas();
          return;
        }
        const supported = fullscreenSupported();
        ui.fullscreenToggle.disabled = !supported;
        ui.fullscreenToggle.setAttribute("aria-pressed", active ? "true" : "false");
        if (supported) {
          ui.fullscreenToggle.textContent = active ? "é€€å‡ºå…¨å±" : "è¿›å…¥å…¨å±";
          ui.fullscreenToggle.title = active ? "é€€å‡ºå…¨å±" : "è¿›å…¥å…¨å±";
        } else {
          ui.fullscreenToggle.textContent = "å…¨å±ä¸å¯ç”¨";
          ui.fullscreenToggle.title = "å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå…¨å±";
        }
        resizeCanvas();
      }

      async function toggleFullscreen() {
        if (!fullscreenSupported()) {
          setNotice("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒå…¨å±ã€‚");
          return;
        }
        try {
          if (isFullscreen()) {
            await exitFullscreen();
          } else {
            await requestFullscreen(document.documentElement);
          }
        } catch (error) {
          setNotice("æ— æ³•è¿›å…¥å…¨å±ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ã€‚");
        }
      }

      function updateMicIndicator() {
        let text = "éº¦å…‹é£æœªå¼€å¯";
        let className = "mic-toggle off";
        let pressed = "false";
        let disabled = false;

        if (!state.audioSupported) {
          text = "éº¦å…‹é£ä¸å¯ç”¨";
          className = "mic-toggle blocked";
          disabled = true;
        } else if (state.micPending) {
          text = "è¯·æ±‚æƒé™ä¸­";
          className = "mic-toggle pending";
          disabled = true;
        } else if (state.stream) {
          text = "éº¦å…‹é£å·²å¼€å¯";
          className = "mic-toggle on";
          pressed = "true";
        } else if (state.demoMode) {
          text = state.micDenied ? "æœªæˆæƒ Â· æ¼”ç¤ºä¸­" : "æ¼”ç¤ºæ¨¡å¼";
          className = "mic-toggle demo";
        } else if (state.micDenied) {
          text = "éº¦å…‹é£æœªæˆæƒ";
          className = "mic-toggle blocked";
        }

        ui.micToggle.className = className;
        ui.micToggle.setAttribute("aria-pressed", pressed);
        ui.micToggle.disabled = disabled;
        ui.micLabel.textContent = text;
        ui.statusBadge.disabled = state.calibrating || state.micPending;
      }

      async function toggleMic() {
        if (state.micPending) {
          return;
        }
        if (state.stream) {
          stopAudio();
          if (!state.demoMode) {
            stopSampling();
            state.currentDb = Number.NaN;
            state.smoothDb = state.minDb;
            updateDbDisplay(state.currentDb);
          }
          setNotice("éº¦å…‹é£å·²å…³é—­ã€‚");
          updateMicIndicator();
          return;
        }
        const ok = await startAudio();
        if (ok) {
          setNotice("éº¦å…‹é£å·²å¼€å¯ã€‚");
          if (!state.running) {
            setStatus("idle", "æœªå¼€å§‹");
            setHint("éº¦å…‹é£å·²å¼€å¯ï¼Œå¯ç‚¹å‡»å¼€å§‹");
          }
        }
      }

      function toggleDemoMode() {
        if (state.calibrating || state.micPending) {
          return;
        }
        if (state.demoLocked) {
          setNotice("å½“å‰è®¾å¤‡ä¸æ”¯æŒéº¦å…‹é£ï¼Œå·²ä¿æŒæ¼”ç¤ºæ¨¡å¼ã€‚");
          updateDemoPanel();
          return;
        }
        if (!state.demoMode) {
          stopAudio();
          state.demoMode = true;
          state.running = true;
          state.paused = false;
          state.loudSince = null;
          state.loudTier = 0;
          state.lastFireworkAt = 0;
          state.comboCount = 0;
          state.comboLastAt = 0;
          state.comboTier = 0;
          fireworks.length = 0;
          floaties.length = 0;
          updateComboText(0);
          enableDemoMode("å·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ï¼Œå¯æ‹–åŠ¨æ»‘å—æ¨¡æ‹ŸéŸ³é‡ã€‚");
          setStatus("demo", "æ¼”ç¤ºä¸­");
          setHint("");
          updateDemoPanel();
          updateControls();
          updateDbDisplay(state.currentDb);
          ui.startBtn.disabled = true;
          ui.pauseBtn.disabled = false;
          ui.resetBtn.disabled = false;
          return;
        }
        state.demoMode = false;
        state.running = false;
        state.paused = false;
        state.loudSince = null;
        state.loudTier = 0;
        state.lastFireworkAt = 0;
        state.comboCount = 0;
        state.comboLastAt = 0;
        state.comboTier = 0;
        fireworks.length = 0;
        floaties.length = 0;
        updateComboText(0);
        stopSampling();
        stopAudio();
        setStatus("idle", "æœªå¼€å§‹");
        setHint("ç‚¹å‡»å¼€å§‹è·å–éº¦å…‹é£æƒé™");
        updateDemoPanel();
        updateControls();
        updateDbDisplay(state.currentDb);
        updateMicIndicator();
        ui.startBtn.disabled = false;
        ui.pauseBtn.disabled = true;
        ui.resetBtn.disabled = true;
        setNotice("å·²é€€å‡ºæ¼”ç¤ºæ¨¡å¼ã€‚");
      }

      function handleStatusClick() {
        if (state.calibrating || state.micPending) {
          return;
        }
        if (!state.running) {
          startApp();
          return;
        }
        togglePause();
      }

      function computeDbFromAnalyser() {
        if (!state.analyser || !state.dataArray) {
          return state.rawDb;
        }
        state.analyser.getByteTimeDomainData(state.dataArray);
        let sum = 0;
        for (let i = 0; i < state.dataArray.length; i += 1) {
          const v = (state.dataArray[i] - 128) / 128;
          sum += v * v;
        }
        const rms = Math.sqrt(sum / state.dataArray.length) || 0.0001;
        const db = 20 * Math.log10(rms) + state.dbOffset;
        return clamp(db, state.minDb - 10, state.maxDb + 10);
      }

      function startSampling() {
        stopSampling();
        state.sampleTimer = window.setInterval(() => {
          if (state.demoMode) {
            state.rawDb = state.demoDb;
          } else {
            state.rawDb = computeDbFromAnalyser();
          }
          state.currentDb = state.rawDb;
          state.smoothDb = lerp(state.smoothDb, state.currentDb, state.smoothing);
          updateDbDisplay(state.currentDb);
        }, 80);
      }

      function stopSampling() {
        if (state.sampleTimer) {
          window.clearInterval(state.sampleTimer);
          state.sampleTimer = null;
        }
      }

      async function startAudio() {
        if (state.stream && state.audioCtx) {
          updateMicIndicator();
          return true;
        }
        if (state.demoMode && state.demoLocked) {
          setNotice("å½“å‰è®¾å¤‡ä¸æ”¯æŒéº¦å…‹é£ï¼Œå·²ä¿æŒæ¼”ç¤ºæ¨¡å¼ã€‚");
          updateMicIndicator();
          return false;
        }

        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          state.audioSupported = false;
          state.micDenied = false;
          enableDemoMode("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£æ¥å£ï¼Œå·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ã€‚");
          return false;
        }

        try {
          state.micPending = true;
          updateMicIndicator();
          const stream = await navigator.mediaDevices.getUserMedia({
            audio: {
              echoCancellation: false,
              noiseSuppression: false,
              autoGainControl: false
            }
          });
          const AudioContextClass = window.AudioContext || window.webkitAudioContext;
          if (!AudioContextClass) {
            state.audioSupported = false;
            state.micDenied = false;
            stream.getTracks().forEach((track) => track.stop());
            enableDemoMode("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘ä¸Šä¸‹æ–‡ï¼Œå·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ã€‚");
            return false;
          }
          state.stream = stream;
          state.audioCtx = new AudioContextClass();
          await state.audioCtx.resume();
          const source = state.audioCtx.createMediaStreamSource(stream);
          state.analyser = state.audioCtx.createAnalyser();
          state.analyser.fftSize = 2048;
          source.connect(state.analyser);
          state.dataArray = new Uint8Array(state.analyser.fftSize);
          state.demoMode = false;
          state.micDenied = false;
          updateDemoPanel();
          setNotice("");
          startSampling();
          return true;
        } catch (error) {
          state.micDenied = true;
          enableDemoMode("æœªè·å¾—éº¦å…‹é£æƒé™ï¼Œå·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ã€‚å¯åœ¨æµè§ˆå™¨è®¾ç½®ä¸­å¼€å¯æƒé™ã€‚");
          return false;
        } finally {
          state.micPending = false;
          updateMicIndicator();
        }
      }

      function stopAudio() {
        if (state.stream) {
          state.stream.getTracks().forEach((track) => track.stop());
        }
        if (state.audioCtx) {
          state.audioCtx.close();
        }
        state.stream = null;
        state.audioCtx = null;
        state.analyser = null;
        state.dataArray = null;
        updateMicIndicator();
      }

      function enableDemoMode(message) {
        state.demoMode = true;
        state.demoLocked = !state.audioSupported;
        updateDemoPanel();
        setNotice(message);
        setStatus("demo", "æ¼”ç¤ºæ¨¡å¼");
        setHint("æ¼”ç¤ºæ¨¡å¼ï¼šæ‹–åŠ¨æ»‘å—æ¨¡æ‹ŸéŸ³é‡");
        startSampling();
        updateMicIndicator();
      }

      function resetState() {
        state.theme = DEFAULTS.theme;
        state.ballCount = DEFAULTS.ballCount;
        state.thresholdDb = DEFAULTS.thresholdDb;
        state.smoothing = DEFAULTS.smoothing;
        state.currentDb = DEFAULTS.thresholdDb;
        state.smoothDb = DEFAULTS.thresholdDb;
        state.rawDb = DEFAULTS.thresholdDb;
        state.demoDb = DEFAULTS.thresholdDb;
        state.running = false;
        state.paused = false;
        state.lowVolumeHintActive = false;
        state.lowVolumeSince = null;
        state.highVolumeSince = null;
        state.loudSince = null;
        state.loudTier = 0;
        state.lastFireworkAt = 0;
        state.comboCount = 0;
        state.comboLastAt = 0;
        state.comboTier = 0;
        fireworks.length = 0;
        floaties.length = 0;
        updateComboText(0);
        stopSampling();
        stopAudio();
        if (!state.demoLocked && !state.micDenied) {
          state.demoMode = false;
          setStatus("idle", "æœªå¼€å§‹");
          setHint("ç‚¹å‡»å¼€å§‹è·å–éº¦å…‹é£æƒé™");
        } else {
          state.demoMode = true;
          setStatus("demo", "æ¼”ç¤ºæ¨¡å¼");
          setHint("æ¼”ç¤ºæ¨¡å¼ï¼šæ‹–åŠ¨æ»‘å—æ¨¡æ‹ŸéŸ³é‡");
        }
        updateDemoPanel();
        updateControls();
        activateTheme(state.theme);
        updateDbDisplay(state.currentDb);
        updateMicIndicator();
        ui.pauseBtn.disabled = true;
        ui.resetBtn.disabled = true;
        ui.startBtn.disabled = false;
        ui.calibrationResult.classList.remove("active");
        ui.calibrationResult.innerHTML = "";
        setNotice("");
        layoutBalls();
      }

      function computeTargetJump(db, ball) {
        const { minDb, maxDb, thresholdDb } = state;
        const maxJump = ball.maxJump;
        if (db <= minDb) {
          return maxJump * 0.02;
        }
        if (db < thresholdDb) {
          const t = clamp((db - minDb) / (thresholdDb - minDb), 0, 1);
          const eased = Math.pow(t, 1.6);
          return maxJump * (0.04 + 0.12 * eased);
        }
        const t = clamp((db - thresholdDb) / (maxDb - thresholdDb), 0, 1);
        const eased = Math.pow(t, 0.7);
        return maxJump * (0.18 + 0.82 * eased);
      }

      function updateBalls(dt) {
        const db = state.smoothDb;
        const normalized = clamp((db - state.minDb) / (state.maxDb - state.minDb), 0, 1);
        balls.forEach((ball) => {
          ball.targetJump = computeTargetJump(db, ball);
          ball.jump = lerp(ball.jump, ball.targetJump, 0.12);
          const speedBoost = 0.6 + normalized * 1.2;
          ball.phase += dt * ball.speed * speedBoost;
          ball.wavePhase += dt * (1.2 + normalized * 2);
        });
      }

      function drawRoundedRectPath(x, y, width, height, radius) {
        const r = Math.min(radius, width * 0.5, height * 0.5);
        ctx.beginPath();
        ctx.moveTo(x + r, y);
        ctx.lineTo(x + width - r, y);
        ctx.quadraticCurveTo(x + width, y, x + width, y + r);
        ctx.lineTo(x + width, y + height - r);
        ctx.quadraticCurveTo(x + width, y + height, x + width - r, y + height);
        ctx.lineTo(x + r, y + height);
        ctx.quadraticCurveTo(x, y + height, x, y + height - r);
        ctx.lineTo(x, y + r);
        ctx.quadraticCurveTo(x, y, x + r, y);
        ctx.closePath();
      }

      function drawStarShape(x, y, r, rotation) {
        const spikes = 5;
        const outer = r;
        const inner = r * 0.45;
        ctx.save();
        ctx.translate(x, y);
        ctx.rotate(rotation);
        ctx.beginPath();
        for (let i = 0; i < spikes * 2; i += 1) {
          const angle = (Math.PI / spikes) * i - Math.PI / 2;
          const radius = i % 2 === 0 ? outer : inner;
          const px = Math.cos(angle) * radius;
          const py = Math.sin(angle) * radius;
          if (i === 0) {
            ctx.moveTo(px, py);
          } else {
            ctx.lineTo(px, py);
          }
        }
        ctx.closePath();
        ctx.restore();
      }

      function spawnStarRain(intensity) {
        const width = state.canvasWidth;
        const height = state.canvasHeight;
        if (!width || !height) {
          return;
        }
        const count = Math.floor(8 + intensity * 6 + Math.random() * 6);
        for (let i = 0; i < count; i += 1) {
          floaties.push({
            kind: "star",
            x: Math.random() * width,
            y: -20 - Math.random() * height * 0.1,
            vx: lerp(-20, 20, Math.random()),
            vy: lerp(40, 110, Math.random()) * (0.75 + intensity * 0.2),
            life: 2.4,
            ttl: 2.4,
            size: lerp(3, 6, Math.random()) * (0.85 + intensity * 0.15),
            rotation: Math.random() * Math.PI,
            spin: lerp(-2.2, 2.2, Math.random()),
            color: starColors[Math.floor(Math.random() * starColors.length)]
          });
        }
      }

      function spawnBubbleRise(intensity) {
        const width = state.canvasWidth;
        const height = state.canvasHeight;
        if (!width || !height) {
          return;
        }
        const count = Math.floor(6 + intensity * 4 + Math.random() * 4);
        for (let i = 0; i < count; i += 1) {
          floaties.push({
            kind: "bubble",
            x: Math.random() * width,
            y: height + Math.random() * height * 0.1,
            vx: lerp(-10, 10, Math.random()),
            vy: lerp(-70, -35, Math.random()) * (0.75 + intensity * 0.2),
            life: 3.2,
            ttl: 3.2,
            size: lerp(6, 14, Math.random()) * (0.85 + intensity * 0.15),
            wobble: Math.random() * Math.PI * 2,
            color: bubbleColors[Math.floor(Math.random() * bubbleColors.length)]
          });
        }
      }

      function spawnRibbonFall(intensity) {
        const width = state.canvasWidth;
        const height = state.canvasHeight;
        if (!width || !height) {
          return;
        }
        const count = Math.floor(10 + intensity * 8 + Math.random() * 6);
        for (let i = 0; i < count; i += 1) {
          floaties.push({
            kind: "ribbon",
            x: Math.random() * width,
            y: -30 - Math.random() * height * 0.1,
            vx: lerp(-18, 18, Math.random()),
            vy: lerp(70, 140, Math.random()) * (0.8 + intensity * 0.2),
            life: 2.4,
            ttl: 2.4,
            width: lerp(4, 8, Math.random()) * (0.85 + intensity * 0.2),
            height: lerp(16, 34, Math.random()) * (0.85 + intensity * 0.2),
            rotation: Math.random() * Math.PI,
            spin: lerp(-3, 3, Math.random()),
            wobble: Math.random() * Math.PI * 2,
            color: ribbonColors[Math.floor(Math.random() * ribbonColors.length)]
          });
        }
      }

      function spawnCandyBurst(tierConfig) {
        const width = state.canvasWidth;
        const height = state.canvasHeight;
        if (!width || !height) {
          return;
        }
        const intensity = tierConfig ? tierConfig.intensity : 1;
        const originX = lerp(width * 0.12, width * 0.88, Math.random());
        const originY = lerp(height * 0.12, height * 0.42, Math.random());
        const count = Math.floor((20 + Math.random() * 14) * intensity);
        for (let i = 0; i < count; i += 1) {
          const angle = Math.random() * Math.PI * 2;
          const speed = lerp(100, 220, Math.random()) * intensity;
          const ttl = lerp(0.8, 1.4, Math.random());
          const glow = Math.random() < 0.35 * intensity ? lerp(2, 3.2, Math.random()) : 0;
          const width = lerp(3, 7, Math.random()) * (0.85 + intensity * 0.15);
          const height = lerp(2, 5, Math.random()) * (0.85 + intensity * 0.15);
          fireworks.push({
            x: originX,
            y: originY,
            vx: Math.cos(angle) * speed,
            vy: Math.sin(angle) * speed,
            life: ttl,
            ttl,
            size: lerp(2, 4.2, Math.random()) * (0.85 + intensity * 0.2),
            width,
            height,
            glow,
            shape: "candy",
            rotation: Math.random() * Math.PI,
            spin: lerp(-4, 4, Math.random()),
            color: candyColors[Math.floor(Math.random() * candyColors.length)]
          });
        }
      }

      function spawnTierEffects(tier, tierConfig) {
        if (tier === 1) {
          spawnStarRain(tierConfig.intensity);
          spawnBubbleRise(tierConfig.intensity);
          return;
        }
        if (tier === 2) {
          spawnCandyBurst(tierConfig);
          return;
        }
        spawnCandyBurst(tierConfig);
        spawnRibbonFall(tierConfig.intensity);
      }

      function updateFloaties(dt) {
        for (let i = floaties.length - 1; i >= 0; i -= 1) {
          const particle = floaties[i];
          particle.life -= dt;
          if (particle.life <= 0) {
            floaties.splice(i, 1);
            continue;
          }
          if (particle.kind === "bubble") {
            particle.wobble += dt * 2;
            particle.x += particle.vx * dt + Math.sin(particle.wobble) * 10 * dt;
            particle.y += particle.vy * dt;
            particle.vy -= 6 * dt;
            continue;
          }
          if (particle.kind === "ribbon") {
            particle.wobble += dt * 2.5;
            particle.x += particle.vx * dt + Math.sin(particle.wobble) * 14 * dt;
            particle.y += particle.vy * dt;
            particle.vy += 35 * dt;
            particle.rotation += particle.spin * dt;
            continue;
          }
          particle.x += particle.vx * dt;
          particle.y += particle.vy * dt;
          particle.vy += 18 * dt;
          particle.rotation += particle.spin * dt;
        }
      }

      function drawFloaties() {
        if (!floaties.length) {
          return;
        }
        ctx.save();
        ctx.globalCompositeOperation = "lighter";
        floaties.forEach((particle) => {
          const alpha = clamp(particle.life / particle.ttl, 0, 1);
          if (particle.kind === "star") {
            ctx.globalAlpha = alpha;
            ctx.fillStyle = particle.color;
            drawStarShape(particle.x, particle.y, particle.size, particle.rotation);
            ctx.fill();
            return;
          }
          if (particle.kind === "bubble") {
            ctx.globalAlpha = alpha * 0.4;
            ctx.fillStyle = particle.color;
            ctx.beginPath();
            ctx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
            ctx.fill();
            ctx.globalAlpha = alpha * 0.9;
            ctx.strokeStyle = particle.color;
            ctx.lineWidth = 1.2;
            ctx.stroke();
            return;
          }
          if (particle.kind === "ribbon") {
            ctx.save();
            ctx.globalAlpha = alpha * 0.9;
            ctx.translate(particle.x, particle.y);
            ctx.rotate(particle.rotation);
            ctx.fillStyle = particle.color;
            drawRoundedRectPath(-particle.width / 2, -particle.height / 2, particle.width, particle.height, particle.width * 0.4);
            ctx.fill();
            ctx.restore();
          }
        });
        ctx.restore();
      }

      function updateFireworks(dt, timestamp) {
        const canEmit = state.running && !state.paused && !state.calibrating;
        if (canEmit) {
          const tier = getComboTier(state.smoothDb);
          if (tier > 0) {
            if (state.loudTier !== tier) {
              state.loudTier = tier;
              state.loudSince = timestamp;
            }
            const tierConfig = getComboTierConfig(tier);
            if (timestamp - state.loudSince >= state.comboSettings.sustainMs &&
                timestamp - state.lastFireworkAt >= tierConfig.intervalMs) {
              spawnTierEffects(tier, tierConfig);
              state.lastFireworkAt = timestamp;
              state.comboCount += 1;
              state.comboLastAt = timestamp;
              state.comboTier = tier;
              updateComboText(state.comboCount, tier);
            }
          } else {
            state.loudSince = null;
            state.loudTier = 0;
          }
        } else {
          state.loudSince = null;
          state.loudTier = 0;
        }

        if (state.comboCount > 0 && timestamp - state.comboLastAt > 1600) {
          state.comboCount = 0;
          state.comboTier = 0;
          updateComboText(0);
        }

        for (let i = fireworks.length - 1; i >= 0; i -= 1) {
          const spark = fireworks[i];
          spark.life -= dt;
          if (spark.life <= 0) {
            fireworks.splice(i, 1);
            continue;
          }
          if (spark.ring) {
            spark.radius += spark.grow * dt;
            continue;
          }
          if (spark.spin) {
            spark.rotation += spark.spin * dt;
          }
          spark.x += spark.vx * dt;
          spark.y += spark.vy * dt;
          spark.vy += 140 * dt;
          spark.vx *= 0.98;
        }
      }

      function drawFireworks() {
        if (!fireworks.length) {
          return;
        }
        ctx.save();
        ctx.globalCompositeOperation = "lighter";
        fireworks.forEach((spark) => {
          const alpha = clamp(spark.life / spark.ttl, 0, 1);
          if (spark.ring) {
            ctx.globalAlpha = alpha * 0.6;
            ctx.strokeStyle = spark.color;
            ctx.lineWidth = 2;
            ctx.beginPath();
            ctx.arc(spark.x, spark.y, spark.radius, 0, Math.PI * 2);
            ctx.stroke();
            return;
          }
          if (spark.shape === "candy") {
            ctx.save();
            ctx.globalAlpha = alpha;
            ctx.translate(spark.x, spark.y);
            ctx.rotate(spark.rotation);
            ctx.fillStyle = spark.color;
            drawRoundedRectPath(-spark.width / 2, -spark.height / 2, spark.width, spark.height, Math.min(spark.width, spark.height) * 0.6);
            ctx.fill();
            if (spark.glow) {
              ctx.globalAlpha = alpha * 0.35;
              const glowWidth = spark.width * spark.glow;
              const glowHeight = spark.height * spark.glow;
              drawRoundedRectPath(-glowWidth / 2, -glowHeight / 2, glowWidth, glowHeight, Math.min(glowWidth, glowHeight) * 0.6);
              ctx.fill();
            }
            ctx.restore();
            return;
          }
          ctx.globalAlpha = alpha;
          ctx.fillStyle = spark.color;
          ctx.beginPath();
          ctx.arc(spark.x, spark.y, spark.size, 0, Math.PI * 2);
          ctx.fill();
          if (spark.glow) {
            ctx.globalAlpha = alpha * 0.4;
            ctx.beginPath();
            ctx.arc(spark.x, spark.y, spark.size * spark.glow, 0, Math.PI * 2);
            ctx.fill();
          }
        });
        ctx.restore();
      }

      function drawBackground(width, height) {
        const gradient = ctx.createLinearGradient(0, 0, width, height);
        gradient.addColorStop(0, "rgba(255, 255, 255, 0.4)");
        gradient.addColorStop(1, "rgba(113, 199, 184, 0.08)");
        ctx.fillStyle = gradient;
        ctx.fillRect(0, 0, width, height);

        ctx.save();
        ctx.globalAlpha = 0.25;
        ctx.strokeStyle = "rgba(255, 255, 255, 0.6)";
        ctx.lineWidth = 1;
        for (let i = 0; i < height; i += 40) {
          ctx.beginPath();
          ctx.moveTo(0, i);
          ctx.lineTo(width, i);
          ctx.stroke();
        }
        ctx.restore();
      }

      function drawPlastic(ball, x, y, r, paletteIndex) {
        const colors = palette[paletteIndex % palette.length];
        const gradient = ctx.createRadialGradient(x - r * 0.3, y - r * 0.4, r * 0.2, x, y, r);
        gradient.addColorStop(0, colors[0]);
        gradient.addColorStop(1, colors[1]);
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();

        ctx.globalAlpha = 0.35;
        ctx.fillStyle = "#fff";
        ctx.beginPath();
        ctx.arc(x - r * 0.35, y - r * 0.35, r * 0.22, 0, Math.PI * 2);
        ctx.fill();
        ctx.globalAlpha = 1;

        ctx.strokeStyle = "rgba(0, 0, 0, 0.15)";
        ctx.lineWidth = 1;
        ctx.stroke();
      }

      function drawEmoji(ball, x, y, r) {
        ctx.fillStyle = "rgba(255, 255, 255, 0.7)";
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "rgba(0, 0, 0, 0.12)";
        ctx.stroke();

        ctx.font = `${Math.floor(r * 1.1)}px "Apple Color Emoji", "Segoe UI Emoji", sans-serif`;
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(ball.emoji, x, y + 2);
      }

      function drawDigit(ball, x, y, r, paletteIndex) {
        const colors = palette[paletteIndex % palette.length];
        ctx.fillStyle = colors[0];
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();
        ctx.strokeStyle = "rgba(255, 255, 255, 0.65)";
        ctx.lineWidth = 2;
        ctx.stroke();

        ctx.font = `${Math.floor(r * 0.95)}px "PingFang SC", "Microsoft YaHei", sans-serif`;
        ctx.fillStyle = "#fff";
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillText(String(ball.index + 1), x, y + 1);
      }

      function drawStar(ball, x, y, r, paletteIndex) {
        const spikes = 5;
        const outer = r;
        const inner = r * 0.45;
        ctx.beginPath();
        for (let i = 0; i < spikes * 2; i += 1) {
          const angle = (Math.PI / spikes) * i - Math.PI / 2;
          const radius = i % 2 === 0 ? outer : inner;
          const px = x + Math.cos(angle) * radius;
          const py = y + Math.sin(angle) * radius;
          if (i === 0) {
            ctx.moveTo(px, py);
          } else {
            ctx.lineTo(px, py);
          }
        }
        ctx.closePath();
        const colors = palette[paletteIndex % palette.length];
        const gradient = ctx.createLinearGradient(x - r, y - r, x + r, y + r);
        gradient.addColorStop(0, colors[0]);
        gradient.addColorStop(1, colors[1]);
        ctx.fillStyle = gradient;
        ctx.fill();
        ctx.strokeStyle = "rgba(255, 255, 255, 0.6)";
        ctx.lineWidth = 1.5;
        ctx.stroke();
      }

      function drawCrystal(ball, x, y, r) {
        const gradient = ctx.createRadialGradient(x - r * 0.3, y - r * 0.3, r * 0.2, x, y, r);
        gradient.addColorStop(0, "rgba(255, 255, 255, 0.95)");
        gradient.addColorStop(0.5, "rgba(165, 230, 230, 0.7)");
        gradient.addColorStop(1, "rgba(73, 178, 184, 0.7)");
        ctx.fillStyle = gradient;
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();

        ctx.globalAlpha = 0.5;
        ctx.strokeStyle = "rgba(255, 255, 255, 0.8)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x - r * 0.1, y - r * 0.15, r * 0.55, -0.2, Math.PI * 1.2);
        ctx.stroke();
        ctx.globalAlpha = 1;
      }

      function drawWave(ball, x, y, r, paletteIndex) {
        const colors = palette[paletteIndex % palette.length];
        ctx.fillStyle = colors[1];
        ctx.beginPath();
        ctx.arc(x, y, r, 0, Math.PI * 2);
        ctx.fill();

        ctx.strokeStyle = "rgba(255, 255, 255, 0.7)";
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.arc(x, y, r * 0.65, 0, Math.PI * 2);
        ctx.stroke();

        const waveRadius = r * (1.1 + 0.15 * Math.sin(ball.wavePhase));
        ctx.globalAlpha = 0.5;
        ctx.strokeStyle = "rgba(255, 255, 255, 0.6)";
        ctx.lineWidth = 1.5;
        ctx.beginPath();
        ctx.arc(x, y, waveRadius, 0, Math.PI * 2);
        ctx.stroke();
        ctx.globalAlpha = 1;
      }

      function drawBall(ball) {
        const bounce = Math.abs(Math.sin(ball.phase)) * ball.jump;
        const x = ball.x;
        const y = ball.baseY - bounce;
        const r = ball.radius;
        const paletteIndex = ball.index;

        switch (state.theme) {
          case "emoji":
            drawEmoji(ball, x, y, r);
            break;
          case "digit":
            drawDigit(ball, x, y, r, paletteIndex);
            break;
          case "star":
            drawStar(ball, x, y, r, paletteIndex);
            break;
          case "crystal":
            drawCrystal(ball, x, y, r);
            break;
          case "wave":
            drawWave(ball, x, y, r, paletteIndex);
            break;
          case "plastic":
          default:
            drawPlastic(ball, x, y, r, paletteIndex);
        }
      }

      function render() {
        const width = state.canvasWidth;
        const height = state.canvasHeight;
        ctx.clearRect(0, 0, width, height);
        drawBackground(width, height);
        drawFloaties();
        drawFireworks();
        balls.forEach(drawBall);
      }

      function animate(timestamp) {
        const dt = state.lastFrame ? (timestamp - state.lastFrame) / 1000 : 0;
        state.lastFrame = timestamp;
        updateFireworks(dt, timestamp);
        updateFloaties(dt);
        if (state.running && !state.paused && !state.calibrating) {
          updateBalls(dt);
        }
        const width = state.canvasWidth;
        const height = state.canvasHeight;
        ctx.clearRect(0, 0, width, height);
        drawBackground(width, height);
        drawFloaties();
        drawFireworks();
        balls.forEach(drawBall);
        requestAnimationFrame(animate);
      }

      function layoutBalls() {
        balls.length = 0;
        const rect = ui.stage.getBoundingClientRect();
        const width = rect.width;
        const height = rect.height;
        const count = state.ballCount;
        if (count === 0 || width === 0 || height === 0) {
          return;
        }
        const paddingX = Math.max(16, width * 0.04);
        const paddingBottom = Math.max(18, height * 0.08);
        const availableWidth = Math.max(0, width - paddingX * 2);
        if (availableWidth <= 0) {
          return;
        }
        const cellW = availableWidth / count;
        const radius = Math.min(cellW * 0.38, height * 0.18);
        const baseY = height - paddingBottom - radius;
        const maxJump = Math.min(height * 0.6, Math.max(radius * 0.9, height - 2 * paddingBottom - 2 * radius));
        for (let i = 0; i < count; i += 1) {
          balls.push({
            index: i,
            x: paddingX + (i + 0.5) * cellW,
            baseY,
            radius,
            jump: radius * 0.2,
            targetJump: radius * 0.2,
            maxJump,
            phase: Math.random() * Math.PI * 2,
            wavePhase: Math.random() * Math.PI * 2,
            speed: lerp(1.4, 2.6, Math.random()),
            emoji: emojiList[i % emojiList.length]
          });
        }
      }

      function resizeCanvas() {
        const rect = ui.stage.parentElement.getBoundingClientRect();
        const ratio = window.devicePixelRatio || 1;
        if (rect.width === 0 || rect.height === 0) {
          return;
        }
        if (rect.width === state.canvasWidth &&
            rect.height === state.canvasHeight &&
            ratio === state.canvasRatio) {
          return;
        }
        state.canvasRatio = ratio;
        state.canvasWidth = rect.width;
        state.canvasHeight = rect.height;
        ui.stage.width = rect.width * ratio;
        ui.stage.height = rect.height * ratio;
        ctx.setTransform(ratio, 0, 0, ratio, 0, 0);
        layoutBalls();
        render();
      }

      function scheduleResize() {
        if (resizeFrame) {
          return;
        }
        resizeFrame = requestAnimationFrame(() => {
          resizeFrame = null;
          resizeCanvas();
        });
      }

      function startApp() {
        if (state.running) {
          return;
        }
        if (state.demoMode) {
          state.running = true;
          state.paused = false;
          setStatus("demo", "æ¼”ç¤ºä¸­");
          setHint("");
          startSampling();
          ui.startBtn.disabled = true;
          ui.pauseBtn.disabled = false;
          ui.resetBtn.disabled = false;
          return;
        }
        startAudio().then((ok) => {
          if (!ok) {
            state.running = true;
            state.paused = false;
            ui.startBtn.disabled = true;
            ui.pauseBtn.disabled = false;
            ui.resetBtn.disabled = false;
            return;
          }
          state.running = true;
          state.paused = false;
          setStatus("running", "è¿è¡Œä¸­");
          setHint("");
          ui.startBtn.disabled = true;
          ui.pauseBtn.disabled = false;
          ui.resetBtn.disabled = false;
        });
      }

      function togglePause() {
        if (!state.running) {
          return;
        }
        state.paused = !state.paused;
        if (state.paused) {
          setStatus("paused", "å·²æš‚åœ");
          setHint("å·²æš‚åœï¼Œç‚¹å‡»ç»§ç»­");
        } else {
          setStatus(state.demoMode ? "demo" : "running", state.demoMode ? "æ¼”ç¤ºä¸­" : "è¿è¡Œä¸­");
          setHint("");
        }
        updateControls();
      }

      function showModal(title, desc) {
        ui.modalTitle.textContent = title;
        ui.modalDesc.textContent = desc;
        ui.modalProgress.style.width = "0%";
        ui.modal.classList.add("active");
      }

      function updateModalProgress(percent) {
        ui.modalProgress.style.width = `${percent}%`;
      }

      function hideModal() {
        ui.modal.classList.remove("active");
      }

      function hasSeenReviewPopup() {
        try {
          return window.localStorage.getItem(REVIEW_POPUP_KEY) === "1";
        } catch (error) {
          return false;
        }
      }

      function markReviewPopupShown() {
        try {
          window.localStorage.setItem(REVIEW_POPUP_KEY, "1");
        } catch (error) {
          return;
        }
      }

      function showReviewModal() {
        if (!ui.reviewModal) {
          return;
        }
        ui.reviewModal.classList.add("active");
        ui.reviewModal.setAttribute("aria-hidden", "false");
        markReviewPopupShown();
      }

      function hideReviewModal() {
        if (!ui.reviewModal) {
          return;
        }
        ui.reviewModal.classList.remove("active");
        ui.reviewModal.setAttribute("aria-hidden", "true");
      }

      function scheduleReviewModal() {
        if (!ui.reviewModal || hasSeenReviewPopup()) {
          return;
        }
        const delay = REVIEW_DELAY_MIN + Math.random() * (REVIEW_DELAY_MAX - REVIEW_DELAY_MIN);
        reviewTimer = window.setTimeout(() => {
          if (ui.modal && ui.modal.classList.contains("active")) {
            reviewTimer = window.setTimeout(showReviewModal, 30000);
            return;
          }
          showReviewModal();
        }, delay);
      }

      function sampleDb(durationMs, label) {
        return new Promise((resolve) => {
          const samples = [];
          const start = performance.now();
          const timer = window.setInterval(() => {
            samples.push(state.currentDb);
            const elapsed = performance.now() - start;
            updateModalProgress((elapsed / durationMs) * 100);
            if (elapsed >= durationMs) {
              window.clearInterval(timer);
              const avg = samples.reduce((sum, v) => sum + v, 0) / samples.length;
              resolve(avg);
            }
          }, 80);
          ui.modalDesc.textContent = label;
        });
      }

      async function calibrate() {
        if (state.demoMode) {
          setNotice("æ¼”ç¤ºæ¨¡å¼ä¸‹æ— æ³•æ ¡å‡†ï¼Œè¯·å¯ç”¨éº¦å…‹é£åé‡è¯•ã€‚");
          return;
        }
        if (!state.running) {
          const ok = await startAudio();
          if (!ok) {
            return;
          }
          state.running = true;
          ui.startBtn.disabled = true;
          ui.pauseBtn.disabled = false;
          ui.resetBtn.disabled = false;
          setStatus("running", "è¿è¡Œä¸­");
        }
        state.calibrating = true;
        const prevPaused = state.paused;
        state.paused = true;
        updateControls();
        setStatus("paused", "æ ¡å‡†ä¸­");
        setHint("æ ¡å‡†ä¸­ï¼Œè¯·æŒ‰æç¤ºæ“ä½œ");
        showModal("æ ¡å‡†ä¸­", "è¯·ä¿æŒå®‰é™ 2 ç§’");
        const baseline = await sampleDb(2000, "è¯·ä¿æŒå®‰é™ 2 ç§’");
        const reading = await sampleDb(3000, "è¯·æœ—è¯» 3 ç§’");
        hideModal();

        const recommended = Math.round(baseline + (reading - baseline) * 0.6);
        ui.calibrationResult.classList.add("active");
        ui.calibrationResult.innerHTML = `ç¯å¢ƒåŸºçº¿ï¼š${baseline.toFixed(1)} dB<br />æœ—è¯»å‡å€¼ï¼š${reading.toFixed(1)} dB<br />æ¨èé˜ˆå€¼ï¼š${recommended} dB`;
        const applyBtn = document.createElement("button");
        applyBtn.textContent = "ä¸€é”®åº”ç”¨æ¨èé˜ˆå€¼";
        applyBtn.addEventListener("click", () => {
          state.thresholdDb = clamp(recommended, 30, 90);
          updateControls();
          setNotice("å·²åº”ç”¨æ¨èé˜ˆå€¼ã€‚");
        });
        ui.calibrationResult.appendChild(applyBtn);

        state.calibrating = false;
        state.paused = prevPaused;
        updateControls();
        setStatus(state.paused ? "paused" : "running", state.paused ? "å·²æš‚åœ" : "è¿è¡Œä¸­");
        setHint(state.paused ? "å·²æš‚åœï¼Œç‚¹å‡»ç»§ç»­" : "");
      }

      function bindEvents() {
        ui.themeGrid.addEventListener("click", (event) => {
          const btn = event.target.closest(".theme-btn");
          if (!btn) {
            return;
          }
          activateTheme(btn.dataset.theme);
        });

        ui.micToggle.addEventListener("click", toggleMic);
        ui.statusBadge.addEventListener("click", handleStatusClick);
        ui.demoToggle.addEventListener("click", toggleDemoMode);
        if (ui.fullscreenToggle) {
          ui.fullscreenToggle.addEventListener("click", toggleFullscreen);
        }

        ui.ballCount.addEventListener("input", (event) => {
          state.ballCount = Number(event.target.value);
          ui.ballCountValue.textContent = String(state.ballCount);
          layoutBalls();
        });

        ui.thresholdRange.addEventListener("input", (event) => {
          state.thresholdDb = Number(event.target.value);
          ui.thresholdValue.textContent = String(state.thresholdDb);
          ui.thresholdInput.value = state.thresholdDb;
          updateDbDisplay(state.currentDb);
          refreshJumpPreview();
          updateComboSummary();
        });

        ui.thresholdInput.addEventListener("change", (event) => {
          const value = clamp(Number(event.target.value), 30, 90);
          state.thresholdDb = value;
          updateControls();
          updateDbDisplay(state.currentDb);
          refreshJumpPreview();
        });

        if (ui.comboLow) {
          ui.comboLow.addEventListener("change", handleComboInput);
          ui.comboMid.addEventListener("change", handleComboInput);
          ui.comboHigh.addEventListener("change", handleComboInput);
          ui.comboSustain.addEventListener("change", handleComboInput);
          ui.comboReset.addEventListener("click", resetComboSettings);
        }

        ui.presetButtons.forEach((btn) => {
          btn.addEventListener("click", () => {
            state.thresholdDb = Number(btn.dataset.value);
            updateControls();
            updateDbDisplay(state.currentDb);
            refreshJumpPreview();
          });
        });

        ui.startBtn.addEventListener("click", startApp);
        ui.pauseBtn.addEventListener("click", togglePause);
        ui.resetBtn.addEventListener("click", resetState);
        ui.calibrateBtn.addEventListener("click", calibrate);

        ui.demoRange.addEventListener("input", (event) => {
          state.demoDb = Number(event.target.value);
          ui.demoValue.textContent = String(state.demoDb);
        });

        if (ui.reviewModal) {
          ui.reviewModal.addEventListener("click", (event) => {
            if (event.target === ui.reviewModal) {
              hideReviewModal();
            }
          });
        }

        if (ui.reviewClose) {
          ui.reviewClose.addEventListener("click", hideReviewModal);
        }

        if (ui.reviewOk) {
          ui.reviewOk.addEventListener("click", hideReviewModal);
        }

        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" &&
              ui.reviewModal &&
              ui.reviewModal.classList.contains("active")) {
            hideReviewModal();
          }
        });

        window.addEventListener("resize", () => {
          scheduleResize();
        });
        document.addEventListener("fullscreenchange", updateFullscreenUI);
        document.addEventListener("webkitfullscreenchange", updateFullscreenUI);
      }

      function init() {
        applyComboSettings(loadComboSettings());
        updateControls();
        updateDbDisplay(state.currentDb);
        activateTheme(state.theme);
        updateMicIndicator();
        updateStatusActionHint();
        updateDemoPanel();
        bindEvents();
        updateFullscreenUI();
        scheduleReviewModal();
        if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
          state.audioSupported = false;
          enableDemoMode("å½“å‰æµè§ˆå™¨ä¸æ”¯æŒéº¦å…‹é£æ¥å£ï¼Œå·²è¿›å…¥æ¼”ç¤ºæ¨¡å¼ã€‚");
        }
        requestAnimationFrame(animate);
      }

      init();
    })();
  </script>
</body>
</html>
